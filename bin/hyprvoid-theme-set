#!/usr/bin/env bash
# HyprVoid Theme Switcher - Omarchy-inspired symlink-based theming
# Usage: hyprvoid-theme-set <theme-name>

set -Eeuo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/hyprvoid-lib"

THEMES_DIR="$HOME/.config/hyprvoid/themes"
CURRENT_THEME_LINK="$HOME/.config/hyprvoid/current/theme"

if [[ -z "${1:-}" ]]; then
  echo "Usage: hyprvoid-theme-set <theme-name>"
  echo ""
  echo "Available themes:"
  "$SCRIPT_DIR/hyprvoid-theme-list"
  exit 1
fi

THEME_NAME="$1"
THEME_PATH="$THEMES_DIR/$THEME_NAME"

# Validate theme exists
if [[ ! -d "$THEME_PATH" ]]; then
  notify "Theme Error" "Theme '$THEME_NAME' does not exist in $THEMES_DIR"
  log "ERROR: Theme '$THEME_NAME' not found"
  exit 1
fi

log "Switching to theme: $THEME_NAME"

# Update theme symlink atomically
mkdir -p "$(dirname "$CURRENT_THEME_LINK")"
ln -sfn "$THEME_PATH" "$CURRENT_THEME_LINK"

# Apply theme to various applications
"$SCRIPT_DIR/hyprvoid-theme-set-terminal" || true
"$SCRIPT_DIR/hyprvoid-theme-set-gtk" || true
"$SCRIPT_DIR/hyprvoid-theme-set-vscode" || true
"$SCRIPT_DIR/hyprvoid-theme-set-obsidian" || true

# Reload Hyprland to pick up new colors
if command -v hyprctl >/dev/null 2>&1; then
  hyprctl reload 2>/dev/null || true
fi

# Reload Mako notifications
if command -v makoctl >/dev/null 2>&1; then
  makoctl reload 2>/dev/null || true
fi

# Restart Waybar if running
if pgrep -x waybar >/dev/null; then
  pkill waybar
  waybar &
  disown
fi

notify "Theme" "Switched to $THEME_NAME"
log "Theme successfully set to: $THEME_NAME"
