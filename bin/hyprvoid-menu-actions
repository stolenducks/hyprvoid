#!/usr/bin/env bash
set -euo pipefail

# Omarchy-style actions menu for xbps package management

dmenu() {
  local prompt="${1:-Select}"
  if command -v wofi >/dev/null 2>&1; then
    wofi --dmenu --prompt "${prompt}" \
      --conf "${HOME}/.config/wofi/config" \
      --style "${HOME}/.config/wofi/style.css"
  elif command -v fuzzel >/dev/null 2>&1; then
    fuzzel --dmenu --prompt "${prompt}: "
  elif command -v tofi >/dev/null 2>&1; then
    tofi --prompt-text "${prompt}: "
  else
    return 1
  fi
}

confirm() {
  printf "No\nYes\n" | dmenu "Confirm" | grep -qi "^Yes$"
}

run_term() {
  local cmd="$*"
  if command -v alacritty >/dev/null 2>&1; then
    alacritty -e bash -lc "${cmd}; echo; read -n 1 -s -r -p 'Press any key to close...'"
  else
    xdg-terminal-exec bash -lc "${cmd}"
  fi
}

pick_action() {
  printf "  Update System\n  Install Package\n  Remove Package\n  Search Packages\n"
}

main() {
  action="$(pick_action | dmenu 'Actionsâ€¦' || true)"
  case "${action}" in
    *Update*)
      if confirm; then
        run_term "sudo xbps-install -Syu"
        notify-send "System Update" "Completed"
      fi
      ;;
    *Install*)
      pkg="$(printf '' | dmenu 'Package to install' || true)"
      [ -n "${pkg:-}" ] || exit 0
      if confirm; then
        run_term "sudo xbps-install -S ${pkg}"
        notify-send "Install" "Installed ${pkg}"
      fi
      ;;
    *Remove*)
      pkg="$(printf '' | dmenu 'Package to remove' || true)"
      [ -n "${pkg:-}" ] || exit 0
      if confirm; then
        run_term "sudo xbps-remove -R ${pkg}"
        notify-send "Remove" "Removed ${pkg}"
      fi
      ;;
    *Search*)
      query="$(printf '' | dmenu 'Search query' || true)"
      [ -n "${query:-}" ] || exit 0
      results="$(xbps-query -Rs "${query}" 2>/dev/null || true)"
      if [ -z "${results}" ]; then
        notify-send "Search" "No results for ${query}"
        exit 0
      fi
      sel="$(printf "%s\n" "${results}" | dmenu 'Results' || true)"
      [ -n "${sel:-}" ] && notify-send "Package" "${sel}"
      ;;
    *)
      ;;
  esac
}

main "$@"
