#!/usr/bin/env bash
# HyprVoid Restore - Restore from backup snapshot
set -euo pipefail

BACKUP_DIR="${HOME}/.hyprvoid/backups"

# List available backups
echo "ðŸ“¦ Available HyprVoid backups:"
echo ""

backups=($(ls -t "${BACKUP_DIR}"/*-hyprvoid.tar.gz 2>/dev/null || true))

if [[ ${#backups[@]} -eq 0 ]]; then
  echo "âœ— No backups found in ${BACKUP_DIR}"
  exit 1
fi

# Display with numbers
for i in "${!backups[@]}"; do
  backup="${backups[$i]}"
  timestamp=$(basename "$backup" | sed 's/-hyprvoid.tar.gz//')
  size=$(du -h "$backup" | cut -f1)
  echo "  $((i+1)). ${timestamp} (${size})"
done

echo ""
echo -n "Select backup to restore (1-${#backups[@]}) or 'q' to quit: "
read -r choice

[[ "$choice" == "q" ]] && exit 0

if ! [[ "$choice" =~ ^[0-9]+$ ]] || [[ "$choice" -lt 1 ]] || [[ "$choice" -gt ${#backups[@]} ]]; then
  echo "âœ— Invalid selection"
  exit 1
fi

BACKUP_FILE="${backups[$((choice-1))]}"
echo ""
echo "Selected: $(basename "$BACKUP_FILE")"
echo ""
echo "âš ï¸  This will:"
echo "  - Backup current config to a new snapshot"
echo "  - Restore config from selected backup"
echo "  - Overwrite: ~/.config/{hypr,walker,wofi}"
echo "  - Overwrite: ~/.local/share/applications/*.desktop"
echo ""
echo -n "Continue? [y/N]: "
read -r confirm

[[ "$confirm" != "y" ]] && [[ "$confirm" != "Y" ]] && { echo "Cancelled."; exit 0; }

# Create a backup of current state first
echo ""
echo "Creating safety backup of current state..."
"$(dirname "$0")/hyprvoid-backup"

# Extract to temp directory
echo ""
echo "Restoring from backup..."
TEMP=$(mktemp -d)
trap 'rm -rf "$TEMP"' EXIT

tar -xzf "${BACKUP_FILE}" -C "${TEMP}"

# Restore configs
[[ -d "${TEMP}/config/hypr" ]] && {
  rm -rf "${HOME}/.config/hypr"
  cp -r "${TEMP}/config/hypr" "${HOME}/.config/"
  echo "âœ“ Restored ~/.config/hypr"
}

[[ -d "${TEMP}/config/walker" ]] && {
  rm -rf "${HOME}/.config/walker"
  cp -r "${TEMP}/config/walker" "${HOME}/.config/"
  echo "âœ“ Restored ~/.config/walker"
}

[[ -d "${TEMP}/config/wofi" ]] && {
  rm -rf "${HOME}/.config/wofi"
  cp -r "${TEMP}/config/wofi" "${HOME}/.config/"
  echo "âœ“ Restored ~/.config/wofi"
}

[[ -d "${TEMP}/local/share" ]] && {
  mkdir -p "${HOME}/.local/share/applications"
  cp -r "${TEMP}/local/share"/*.desktop "${HOME}/.local/share/applications/" 2>/dev/null || true
  echo "âœ“ Restored desktop entries"
}

echo ""
echo "âœ“ Restore complete!"
echo "  You may need to reload Hyprland: hyprctl reload"
