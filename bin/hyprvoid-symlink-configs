#!/usr/bin/env bash
# HyprVoid Config Symlink Manager
# Idempotently creates symlinks from repo to ~/.config
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "ðŸ”— HyprVoid Symlink Manager"
echo ""
echo "Repository: ${ROOT}"
echo "Target: ${HOME}/.config"
echo ""

# Ensure target directories exist
mkdir -p "${HOME}/.config" "${HOME}/.local/bin"

# Track what we do
declare -a ACTIONS=()

# Function to create symlink safely
link_config() {
  local src="$1"
  local dest="$2"
  local name="$3"
  
  if [[ -L "${dest}" ]]; then
    local current_target="$(readlink "${dest}")"
    if [[ "${current_target}" == "${src}" ]]; then
      ACTIONS+=("  âœ“ ${name} (already linked)")
      return 0
    else
      ACTIONS+=("  âš  ${name} (relinked from ${current_target})")
      rm "${dest}"
      ln -sfn "${src}" "${dest}"
    fi
  elif [[ -e "${dest}" ]]; then
    ACTIONS+=("  âš  ${name} (backed up existing)")
    mv "${dest}" "${dest}.backup.$(date +%s)"
    ln -sfn "${src}" "${dest}"
  else
    ACTIONS+=("  âœ“ ${name} (linked)")
    ln -sfn "${src}" "${dest}"
  fi
}

# Link configurations
[[ -d "${ROOT}/config/hypr" ]] && \
  link_config "${ROOT}/config/hypr" "${HOME}/.config/hypr" "hypr config"

[[ -d "${ROOT}/config/walker" ]] && \
  link_config "${ROOT}/config/walker" "${HOME}/.config/walker" "walker config"

[[ -d "${ROOT}/config/wofi" ]] && \
  link_config "${ROOT}/config/wofi" "${HOME}/.config/wofi" "wofi config"

# Link binaries
for bin in "${ROOT}"/bin/hyprvoid-*; do
  [[ -f "${bin}" ]] || continue
  [[ -x "${bin}" ]] || continue
  
  binname="$(basename "${bin}")"
  dest="${HOME}/.local/bin/${binname}"
  
  if [[ -L "${dest}" ]]; then
    local current_target="$(readlink "${dest}")"
    if [[ "${current_target}" == "${bin}" ]]; then
      ACTIONS+=("  âœ“ ${binname} (already linked)")
    else
      ACTIONS+=("  âš  ${binname} (relinked)")
      ln -sfn "${bin}" "${dest}"
    fi
  else
    ACTIONS+=("  âœ“ ${binname} (linked)")
    ln -sfn "${bin}" "${dest}"
  fi
done

# Print summary
echo "Actions taken:"
printf '%s\n' "${ACTIONS[@]}"
echo ""
echo "âœ“ Symlink management complete"
echo ""
echo "Notes:"
echo "  - Existing files were backed up with .backup.TIMESTAMP suffix"
echo "  - All symlinks point to ${ROOT}"
echo "  - To unlink: remove ~/.config/{hypr,walker,wofi} and ~/.local/bin/hyprvoid-*"
