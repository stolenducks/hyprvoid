#!/usr/bin/env bash
# HyprVoid Obsidian Theme Setter
# Sets Obsidian theme from current HyprVoid theme

set -Eeuo pipefail

# DEBUG LOGGING
LOG_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/hyprvoid"
LOG_FILE="$LOG_DIR/log"
mkdir -p "$LOG_DIR"
echo "[$(date +'%Y-%m-%d %H:%M:%S')] obsidian-theme-set STARTED" >> "$LOG_FILE"

# Get current hyprvoid theme name
CURRENT_THEME_LINK="$HOME/.config/hyprvoid/current/theme"
if [[ -L "$CURRENT_THEME_LINK" ]]; then
  HYPRVOID_THEME=$(basename "$(readlink "$CURRENT_THEME_LINK")")
else
  exit 0
fi

# Switch Obsidian CSS theme using obsidian-theme script
echo "[$(date +'%Y-%m-%d %H:%M:%S')] Calling obsidian-theme switch $HYPRVOID_THEME" >> "$LOG_FILE"
if [[ -x "$HOME/.local/bin/obsidian-theme" ]]; then
  "$HOME/.local/bin/obsidian-theme" switch "$HYPRVOID_THEME" 2>/dev/null || true
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] obsidian-theme switch completed" >> "$LOG_FILE"
else
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] obsidian-theme command not found at $HOME/.local/bin/obsidian-theme" >> "$LOG_FILE"
fi

# Set base color scheme (light/dark mode)
VAULT_DIR="$HOME/Documents/vault-01"
APPEARANCE_FILE="$VAULT_DIR/.obsidian/appearance.json"

if [[ -f "$APPEARANCE_FILE" ]]; then
  case "$HYPRVOID_THEME" in
    rose-pine-dawn)
      # Set to light mode
      sed -i 's/"theme": "[^"]*"/"theme": "obsidian"/' "$APPEARANCE_FILE"
      ;;
    catppuccin-mocha|osaka-jade)
      # Set to dark mode
      sed -i 's/"theme": "[^"]*"/"theme": "moonstone"/' "$APPEARANCE_FILE"
      ;;
  esac
  
  # Notify if Obsidian is running
  if pgrep -x obsidian >/dev/null 2>&1; then
    notify-send "Theme Applied" "Restart Obsidian to see $HYPRVOID_THEME theme" -t 5000
  fi
fi
