#!/usr/bin/env bash
# HyprVoid Background Cycler - Cycle to next wallpaper in current theme

set -Eeuo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/hyprvoid-lib"

WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
STATE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/hyprvoid"
STATE_FILE="$STATE_DIR/current-wallpaper"

# Get current theme
theme="$(detect_theme)"
theme_dir="$WALLPAPER_DIR/$theme"

# Create directories if they don't exist
mkdir -p "$theme_dir" "$STATE_DIR"

# Get list of wallpapers
mapfile -t wallpapers < <(find "$theme_dir" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) 2>/dev/null | sort)

if [[ ${#wallpapers[@]} -eq 0 ]]; then
  notify "Wallpaper" "No wallpapers found in $theme_dir"
  log "No wallpapers in $theme_dir"
  exit 0
fi

# Get current wallpaper index
current_wall=""
if [[ -f "$STATE_FILE" ]]; then
  current_wall="$(cat "$STATE_FILE")"
fi

# Find next wallpaper
next_index=0
for i in "${!wallpapers[@]}"; do
  if [[ "${wallpapers[$i]}" == "$current_wall" ]]; then
    next_index=$(( (i + 1) % ${#wallpapers[@]} ))
    break
  fi
done

next_wall="${wallpapers[$next_index]}"

# Set wallpaper
if command -v hyprctl >/dev/null 2>&1 && pgrep -x hyprpaper >/dev/null; then
  # Use hyprpaper
  hyprctl hyprpaper preload "$next_wall" 2>/dev/null || true
  hyprctl hyprpaper wallpaper ",$next_wall" 2>/dev/null || true
elif command -v swww >/dev/null 2>&1; then
  # Use swww
  swww img "$next_wall" --transition-type fade
elif command -v swaybg >/dev/null 2>&1; then
  # Use swaybg
  killall swaybg 2>/dev/null || true
  swaybg -i "$next_wall" -m fill &
else
  notify "Wallpaper" "No wallpaper tool found. Install hyprpaper, swww, or swaybg"
  exit 1
fi

# Save state
echo "$next_wall" > "$STATE_FILE"

wallpaper_name="$(basename "$next_wall")"
notify "Wallpaper" "$wallpaper_name"
log "Wallpaper set to: $next_wall"
